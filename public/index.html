<!DOCTYPE html>

<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Международные олимпиады — Центр науки и инноваций</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary:#1b365d;
      --accent:#2ecc71;
      --bg:#f5f7fb;
      --text:#2b2b2b;
      --muted:#6b7280;
      --card:#ffffff;
      --shadow:0 6px 18px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
    header{background:var(--primary);color:#fff;padding:30px 16px;text-align:center}
    header h1{font-size:26px;margin-bottom:8px}
    header p{font-size:16px;color:#e2e8f0}
    nav{background:#fff;padding:12px 0;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    nav a{margin:0 12px;text-decoration:none;color:var(--primary);font-weight:600}
    nav a:hover{text-decoration:underline}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .intro{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-top:-24px;text-align:center}
    .intro p{margin-top:8px;color:var(--muted)}
    .events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;margin-top:20px}
    .event-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;transition:.2s ease}
    .event-card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.12)}
    .event-title{color:var(--primary);font-size:18px;margin-bottom:6px}
    .event-desc{font-size:14px;color:var(--muted)}
    .btn{display:inline-block;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:600;margin-top:10px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-accent{background:var(--accent);color:#fff}
    footer{background:var(--primary);color:#fff;padding:16px;text-align:center;font-size:14px;margin-top:40px}
    footer a{color:#fff;text-decoration:underline}
  </style>
</head>
<body>

<header>
  <h1>Центр науки и инноваций</h1>
  <p>Международные олимпиады для учащихся и студентов</p>
</header>

<nav>
  <a href="#olympiads">Олимпиады</a>
  <a href="/docs" target="_blank">Документы и оплата</a>
  <a href="/admin" target="_blank">Админка</a>
</nav>

<div class="container">
  <section class="intro">
    <h2>Добро пожаловать!</h2>
    <p>Выберите олимпиаду, пройдите тест и получите именной диплом или сертификат участника.</p>
  </section>

  <section id="olympiads">
    <h2 style="margin:20px 0 10px;">Список доступных олимпиад</h2>
    <div id="events" class="events-grid"></div>
  </section>
<section id="olympiads">
  <h2 style="margin:20px 0 10px;">Список доступных олимпиад</h2>
  <div id="events" class="events-grid"></div>
</section>
</div>

<footer>
  <p>© 2025 Центр науки и инноваций. Все права защищены.</p>
</footer>

<script>
let events = [];
let currentEvent = null;
let currentQuestions = [];
let answers = [];

async function loadEvents() {
  const res = await fetch('/api/events');
  events = await res.json();
  renderEvents();
}

function renderEvents() {
  const container = document.getElementById('events');
  container.innerHTML = '';
  events.forEach((ev, i) => {
    const card = document.createElement('div');
    card.className = 'event-card';
    card.innerHTML = `
      <h3 class="event-title">${ev.title}</h3>
      <p class="event-desc">${ev.short}</p>
      <button class="btn btn-primary" onclick="openTest(${i})">Пройти тест</button>
    `;
    container.appendChild(card);
  });
}

function openTest(index) {
  currentEvent = events[index];
  currentQuestions = currentEvent.questions;
  answers = new Array(currentQuestions.length).fill(null);

  const container = document.querySelector('.container');
  container.innerHTML = `
    <section class="intro" style="text-align:left;">
      <h2>${currentEvent.title}</h2>
      <p style="white-space:pre-line;">${currentEvent.info}</p>
      <hr style="margin:20px 0;">
      <div id="testContainer"></div>
    </section>
  `;
  renderTest();
}

function renderTest() {
  const box = document.getElementById('testContainer');
  box.innerHTML = '';
  currentQuestions.forEach((q, i) => {
    const qDiv = document.createElement('div');
    qDiv.className = 'event-card';
    qDiv.innerHTML = `
      <p><b>${i + 1}. ${q.q}</b></p>
      ${q.options.map((opt, j) => `
        <label style="display:block;margin:6px 0;">
          <input type="radio" name="q${i}" value="${j}" onchange="answers[${i}] = ${j}">
          ${opt}
        </label>
      `).join('')}
    `;
    box.appendChild(qDiv);
  });
  const btn = document.createElement('button');
  btn.textContent = 'Завершить тест';
  btn.className = 'btn btn-accent';
  btn.onclick = finishTest;
  box.appendChild(btn);
}

function finishTest() {
  if (answers.includes(null)) return alert('Ответьте на все вопросы!');
  let correct = 0;
  for (let i = 0; i < currentQuestions.length; i++) {
    if (answers[i] === currentQuestions[i].correct) correct++;
  }
  const percent = Math.round((correct / currentQuestions.length) * 100);
  showResult(percent);
}

function showResult(percent) {
  let template = 'certificate';
  if (percent > 70) template = 'diploma';
  else if (percent > 50) template = 'diploma';
  else if (percent > 20) template = 'diploma';
  else template = 'certificate';

  const container = document.querySelector('.container');
  container.innerHTML = `
    <section class="intro" style="text-align:left;">
      <h2>Ваш результат: ${percent}%</h2>
      <p>Введите данные для получения документа.</p>
      <input id="fio" placeholder="ФИО участника" style="width:100%;padding:10px;margin:8px 0;">
      <input id="school" placeholder="Учебное заведение" style="width:100%;padding:10px;margin:8px 0;">
      <input id="region" placeholder="Регион" style="width:100%;padding:10px;margin:8px 0;">
      <input id="city" placeholder="Город" style="width:100%;padding:10px;margin:8px 0;">
      <input id="supervisor" placeholder="Научный руководитель (если есть)" style="width:100%;padding:10px;margin:8px 0;">
      <button class="btn btn-primary" onclick="generateDoc('${template}', ${percent})">Скачать документ</button>
    </section>
  `;
}

async function generateDoc(template, percent) {
  const fio = document.getElementById('fio').value.trim();
  const school = document.getElementById('school').value.trim();
  const region = document.getElementById('region').value.trim();
  const city = document.getElementById('city').value.trim();
  const supervisor = document.getElementById('supervisor').value.trim();
  if (!fio || !school || !region || !city) return alert('Заполните все поля');

  const data = {
    fio, school, region, city, supervisor,
    title: currentEvent.title,
    date: new Date().toLocaleDateString('ru-RU'),
    number: Math.floor(Math.random()*1000000),
  };

  const res = await fetch('/api/generate-pdf', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ template, data })
  });

  if (!res.ok) return alert('Ошибка генерации PDF');
  const blob = await res.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${template}.pdf`;
  a.click();
  window.URL.revokeObjectURL(url);
}

loadEvents();
</script>

</body>
</html>
