<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Международные Олимпиады и Конкурсы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--primary:#1b365d;--accent:#2ecc71;--bg:#f5f7fb;--text:#2b2b2b;--muted:#6b7280;--card:#ffffff;--shadow:0 6px 18px rgba(0,0,0,.08);--radius:14px}
    *{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    header{background:var(--primary);color:#fff;padding:28px 16px;text-align:center}
    nav{background:#fff;padding:12px 0;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    nav a{margin:0 12px;text-decoration:none;color:var(--primary);font-weight:600}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .intro{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-top:-24px}
    .badge{display:inline-block;background:#eef2ff;color:#3442b5;border:1px solid #dbe2ff;border-radius:999px;padding:6px 12px;font-size:13px;margin-right:8px}
    .filters{display:flex;justify-content:center;gap:10px;margin:16px 0;flex-wrap:wrap}
    .filter-btn{padding:8px 16px;border:1px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer;font-size:14px}
    .filter-btn.active{background:var(--primary);color:#fff}
    .event-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0}
    .event-title{color:var(--primary);font-size:20px;margin:0 0 10px}
    .event-desc{color:var(--muted);margin:0 0 12px}
    .btn{border:none;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:600;margin:4px}
    .btn-info{background:var(--primary);color:#fff}
    .btn-reg{background:var(--accent);color:#fff}
    .panel{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:20px;margin:22px 0;display:none}
    .panel input{width:100%;padding:12px;border:1px solid #d9dbe3;border-radius:10px;margin:6px 0 10px}
    footer{background:var(--primary);color:#fff;padding:16px;text-align:center;font-size:14px;margin-top:40px}
    footer a{color:#fff;text-decoration:underline}
    pre{white-space:pre-wrap;font-family:inherit;background:#f9fafb;padding:12px;border-radius:8px;margin:10px 0}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:white;padding:20px;border-radius:10px;max-width:500px;width:90%}
    .close{float:right;font-size:24px;cursor:pointer}
  </style>
</head>
<body>
<header>
  <h1>Международные и Всероссийские Олимпиады, Конкурсы и Проекты</h1>
</header>

<nav>
  <a href="/">Главная</a>
  <a href="/docs">Документы и оплата</a>
</nav>

<div class="container">
  <div class="intro">
    <span class="badge">Стоимость участия — бесплатное</span>
    <span class="badge">Наградные документы — 100 ₽</span>
    <p>Для учащихся и молодых исследователей, обладающих значительным научным и интеллектуальным потенциалом, наши мероприятия представляют уникальную возможность реализации собственных способностей на самом высоком уровне.</p>
    <p><b>Почему стоит участвовать?</b></p>
    <ul>
      <li>✅ Подтверждение статуса высококвалифицированного специалиста международными сертификатами</li>
      <li>✅ Объективное сравнение своих знаний с лучшими представителями научного сообщества</li>
      <li>✅ Расширение возможностей карьерного роста и профессионального признания</li>
      <li>✅ Доступ к ведущим научным центрам и образовательным учреждениям</li>
    </ul>
  </div>

  <div class="filters">
    <button class="filter-btn active" data-filter="all">Все</button>
    <button class="filter-btn" data-filter="students">Студентам и аспирантам</button>
    <button class="filter-btn" data-filter="school">Школьникам и СПО</button>
    <button class="filter-btn" data-filter="teachers">Преподавателям и учителям</button>
  </div>

  <div id="eventsList"></div>

  <div id="regPanel" class="panel">
    <h3 id="regTitle">Регистрация на мероприятие</h3>
    <input id="fio" placeholder="Фамилия Имя Отчество" value="Иванов Иван Иванович" />
    <input id="region" placeholder="Регион" value="Краснодарский край" />
    <input id="city" placeholder="Город" value="Краснодар" />
    <input id="school" placeholder="Учебное заведение" value="ФГБОУ ВО Кубанский государственный аграрный университет имени И.Т. Трубилина" />
    <button class="btn btn-reg" onclick="startTest()">Начать тест</button>
  </div>

  <div id="testPanel" class="panel"></div>

  <div id="resultPanel" class="panel"></div>
</div>

<!-- Модальное окно оплаты -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closePaymentModal()">&times;</span>
    <h3>Оплата документа</h3>
    <p>Стоимость: <b>100 ₽</b></p>
    <p>Демо-режим: вы можете пропустить оплату для тестирования.</p>
    <button class="btn btn-reg" onclick="proceedWithoutPayment()">Пропустить оплату (демо)</button>
  </div>
</div>

<footer>
  Почта для связи: <a href="mailto:naych_kooper@mail.ru">naych_kooper@mail.ru</a><br>
  © 2025 Все права защищены. Копирование контента без разрешения автора строго ЗАПРЕЩЕНО!
</footer>

<script>
let EVENTS = [];
let currentEvent = null;
let answers = [];
let currentFilter = 'all';
let pendingPDFType = null;

fetch('/api/events').then(r => r.json()).then(data => {
  EVENTS = data;
  renderEvents();
});

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderEvents();
  });
});

function renderEvents() {
  const filtered = currentFilter === 'all' 
    ? EVENTS 
    : EVENTS.filter(e => e.audience === currentFilter);
  document.getElementById('eventsList').innerHTML = filtered.map(e => `
    <div class="event-card">
      <h3 class="event-title">${e.title}</h3>
      <p class="event-desc">${e.short}</p>
      <pre>${e.info}</pre>
      <button class="btn btn-info" onclick="showInfo('${e.key}')">Подробнее</button>
      <button class="btn btn-reg" onclick="openReg('${e.key}')">Регистрация</button>
    </div>
  `).join('');
}

function showInfo(key) {
  const e = EVENTS.find(x => x.key === key);
  alert(e.info);
}

function openReg(key) {
  currentEvent = EVENTS.find(x => x.key === key);
  document.getElementById('regTitle').textContent = 'Регистрация: ' + currentEvent.title;
  document.getElementById('regPanel').style.display = 'block';
  document.getElementById('testPanel').style.display = 'none';
  document.getElementById('resultPanel').style.display = 'none';
  window.scrollTo({top: document.getElementById('regPanel').offsetTop - 20, behavior:'smooth'});
}

function startTest() {
  document.getElementById('regPanel').style.display = 'none';
  document.getElementById('testPanel').style.display = 'block';
  answers = new Array(currentEvent.questions.length).fill(null);
  renderQuestion(0);
}

function renderQuestion(i) {
  const q = currentEvent.questions[i];
  document.getElementById('testPanel').innerHTML = `
    <h3>Вопрос ${i+1} из ${currentEvent.questions.length}</h3>
    <p>${q.q}</p>
    ${q.options.map((opt, idx) => `
      <label><input type="radio" name="q" value="${idx}"> ${opt}</label><br>
    `).join('')}
    <button class="btn btn-primary" onclick="submitAnswer(${i})">${i === currentEvent.questions.length - 1 ? 'Завершить' : 'Далее'}</button>
    ${i > 0 ? '<button class="btn" onclick="renderQuestion(' + (i - 1) + ')">Назад</button>' : ''}
  `;
}

function submitAnswer(i) {
  const sel = document.querySelector('input[name="q"]:checked');
  if (!sel) { alert('Пожалуйста, выберите вариант ответа.'); return; }
  answers[i] = parseInt(sel.value);
  if (i < currentEvent.questions.length - 1) {
    renderQuestion(i + 1);
  } else {
    finishTest();
  }
}

function finishTest() {
  let correct = 0;
  currentEvent.questions.forEach((q, i) => {
    if (answers[i] === q.correct) correct++;
  });
  const score = Math.round(correct / currentEvent.questions.length * 100);
  const isDiploma = score >= 51;
  
  document.getElementById('testPanel').style.display = 'none';
  document.getElementById('resultPanel').style.display = 'block';
  document.getElementById('resultPanel').innerHTML = `
    <h3>Результаты</h3>
    <p>Ваш результат: <b>${score}%</b></p>
    <input id="supervisor" placeholder="Научный руководитель (преподаватель)">
    <button class="btn btn-reg" onclick="requestPayment('certificate')">Оплатить и скачать сертификат (100 ₽)</button>
    ${isDiploma ? '<button class="btn btn-reg" onclick="requestPayment(\'diploma\')">Оплатить и скачать диплом (100 ₽)</button>' : ''}
    <button class="btn btn-reg" onclick="requestPayment('thanks')">Оплатить и скачать благодарность (100 ₽)</button>
  `;
}

function requestPayment(type) {
  pendingPDFType = type;
  document.getElementById('paymentModal').style.display = 'flex';
}

function closePaymentModal() {
  document.getElementById('paymentModal').style.display = 'none';
}

function proceedWithoutPayment() {
  closePaymentModal();
  const data = {
    title: currentEvent.title,
    fio: document.getElementById('fio').value,
    school: document.getElementById('school').value,
    region: document.getElementById('region').value,
    city: document.getElementById('city').value,
    supervisor: document.getElementById('supervisor').value || '',
    date: '30 сентября 2025 г.',
    number: '1111111111'
  };
  fetch('/api/generate-pdf', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ template: pendingPDFType, data })
  }).then(res => {
    if (res.ok) {
      res.blob().then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${pendingPDFType}.pdf`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }
  });
}
</script>
</body>
</html>
