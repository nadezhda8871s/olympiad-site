<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Международные Олимпиады</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--primary:#1b365d;--accent:#2ecc71;--bg:#f5f7fb;--text:#2b2b2b}
    *{box-sizing:border-box;margin:0;padding:0}body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--primary);color:#fff;padding:20px;text-align:center}
    nav{background:#fff;padding:12px 0;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    nav a{margin:0 12px;text-decoration:none;color:var(--primary);font-weight:600}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .filters{display:flex;justify-content:center;gap:10px;margin:16px 0;flex-wrap:wrap}
    .filter-btn{padding:8px 16px;border:1px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer}
    .filter-btn.active{background:var(--primary);color:#fff}
    .event-card{background:#fff;padding:20px;margin:16px 0;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .btn{padding:10px 16px;background:var(--primary);color:#fff;border:none;border-radius:6px;cursor:pointer;margin:4px}
    .btn-reg{background:var(--accent)}
    .panel{display:none;background:#fff;padding:20px;margin:20px 0;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    input{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:4px}
  </style>
</head>
<body>
<header>
  <h1>Международные и Всероссийские Олимпиады</h1>
</header>

<nav>
  <a href="/">Главная</a>
  <a href="/docs">Документы и оплата</a>
</nav>

<div class="container">
  <div class="filters">
    <button class="filter-btn active" data-filter="all">Все</button>
    <button class="filter-btn" data-filter="students">Студентам и аспирантам</button>
    <button class="filter-btn" data-filter="school">Школьникам и СПО</button>
    <button class="filter-btn" data-filter="teachers">Преподавателям и учителям</button>
  </div>

  <div id="eventsList"></div>

  <div id="regPanel" class="panel">
    <h3 id="regTitle">Регистрация</h3>
    <input id="fio" placeholder="ФИО" value="Иванов Иван Иванович">
    <input id="school" placeholder="Учебное заведение" value="ФГБОУ ВО Кубанский государственный аграрный университет имени И.Т. Трубилина">
    <input id="region" placeholder="Регион" value="Краснодарский край">
    <input id="city" placeholder="Город" value="Краснодар">
    <button class="btn" onclick="startTest()">Начать тест</button>
  </div>

  <div id="testPanel" class="panel"></div>
  <div id="resultPanel" class="panel"></div>
</div>

<footer style="text-align:center;padding:20px;margin-top:40px;background:#1b365d;color:white;">
  Почта: <a href="mailto:naych_kooper@mail.ru" style="color:white;">naych_kooper@mail.ru</a><br>
  © 2025 Все права защищены.
</footer>

<script>
let EVENTS = [];
let currentEvent = null;
let answers = [];
let currentFilter = 'all';

// Загрузка
fetch('/api/events').then(r=>r.json()).then(data=>{
  EVENTS = data;
  renderEvents();
});

document.querySelectorAll('.filter-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderEvents();
  });
});

function renderEvents() {
  const filtered = currentFilter==='all' ? EVENTS : EVENTS.filter(e=>e.audience===currentFilter);
  document.getElementById('eventsList').innerHTML = filtered.map(e=>`
    <div class="event-card">
      <h3>${e.title}</h3>
      <p>${e.short}</p>
      <button class="btn" onclick="showInfo('${e.key}')">Подробнее</button>
      <button class="btn btn-reg" onclick="openReg('${e.key}')">Регистрация</button>
    </div>
  `).join('');
}

function showInfo(key){
  const e = EVENTS.find(x=>x.key===key);
  alert(e.info);
}

function openReg(key){
  currentEvent = EVENTS.find(x=>x.key===key);
  document.getElementById('regTitle').textContent = 'Регистрация: ' + currentEvent.title;
  document.getElementById('regPanel').style.display = 'block';
}

function startTest(){
  document.getElementById('regPanel').style.display = 'none';
  document.getElementById('testPanel').style.display = 'block';
  answers = new Array(currentEvent.questions.length).fill(null);
  renderQuestion(0);
}

function renderQuestion(i){
  const q = currentEvent.questions[i];
  document.getElementById('testPanel').innerHTML = `
    <h3>Вопрос ${i+1} из ${currentEvent.questions.length}</h3>
    <p>${q.q}</p>
    ${q.options.map((opt,idx)=>`<label><input type="radio" name="q" value="${idx}"> ${opt}</label><br>`).join('')}
    <button class="btn" onclick="submitAnswer(${i})">${i===currentEvent.questions.length-1?'Завершить':'Далее'}</button>
  `;
}

function submitAnswer(i){
  const sel = document.querySelector('input[name="q"]:checked');
  if(!sel){alert('Выберите ответ');return;}
  answers[i] = parseInt(sel.value);
  if(i < currentEvent.questions.length-1){
    renderQuestion(i+1);
  } else {
    finishTest();
  }
}

function finishTest(){
  let correct = 0;
  currentEvent.questions.forEach((q,i)=>{
    if(answers[i]===q.correct) correct++;
  });
  const score = Math.round(correct / currentEvent.questions.length * 100);
  const isDiploma = score >= 51;
  
  document.getElementById('testPanel').style.display = 'none';
  document.getElementById('resultPanel').style.display = 'block';
  document.getElementById('resultPanel').innerHTML = `
    <h3>Результат</h3>
    <p>Ваш результат: <b>${score}%</b></p>
    <input id="supervisor" placeholder="Научный руководитель (необязательно)">
    <button class="btn" onclick="payAndDownload('certificate')">Оплатить и скачать сертификат (100 ₽)</button>
    ${isDiploma ? '<button class="btn" onclick="payAndDownload(\'diploma\')">Оплатить и скачать диплом (100 ₽)</button>' : ''}
    <button class="btn" onclick="payAndDownload('thanks')">Оплатить и скачать благодарность (100 ₽)</button>
  `;
}

function payAndDownload(type){
  alert('Заглушка Робокассы: оплата прошла успешно!');
  const data = {
    title: currentEvent.title,
    fio: document.getElementById('fio').value,
    school: document.getElementById('school').value,
    region: document.getElementById('region').value,
    city: document.getElementById('city').value,
    supervisor: document.getElementById('supervisor').value || '',
    date: '30 сентября 2025 г.',
    number: '1111111111'
  };
  fetch('/api/generate-pdf', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({template: type, data})
  }).then(res=>{
    if(res.ok){
      res.blob().then(blob=>{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${type}.pdf`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }
  });
}
</script>
</body>
</html>
