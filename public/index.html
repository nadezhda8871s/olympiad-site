<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Международные Олимпиады и Конкурсы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root{--primary:#1b365d;--accent:#2ecc71;--bg:#f5f7fb;--text:#2b2b2b;--muted:#6b7280;--card:#ffffff;--shadow:0 6px 18px rgba(0,0,0,.08);--shadow-hover:0 10px 24px rgba(0,0,0,.12);--radius:14px}
    *{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    header{background:var(--primary);color:#fff;padding:28px 16px;text-align:center}
    header h1{margin:0;font-size:28px;letter-spacing:.2px}
    nav{background:#fff;padding:12px 0;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    nav a{margin:0 12px;text-decoration:none;color:var(--primary);font-weight:600;font-size:16px}
    nav a:hover{text-decoration:underline}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .intro{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-top:-24px}
    .badge{display:inline-block;background:#eef2ff;color:#3442b5;border:1px solid #dbe2ff;border-radius:999px;padding:6px 12px;font-size:13px;margin-right:8px}
    .filters{display:flex;justify-content:center;gap:10px;margin:16px 0;flex-wrap:wrap}
    .filter-btn{padding:8px 16px;border:1px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer;font-size:14px}
    .filter-btn.active{background:var(--primary);color:#fff}
    .search-wrap{display:flex;gap:10px;justify-content:center;margin:16px 0}
    .search-wrap input{width:100%;max-width:420px;padding:12px 14px;border:1px solid #d9dbe3;border-radius:10px;background:#fff}
    .events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
    .event-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;transition:.2s ease;overflow:hidden}
    .event-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover)}
    .event-header{padding:18px 18px 10px}
    .event-title{margin:0;color:var(--primary);font-size:18px;line-height:1.3}
    .event-desc{color:var(--muted);font-size:14px;padding:0 18px 10px}
    .card-actions{display:flex;gap:10px;padding:14px 18px 18px;margin-top:auto}
    .btn{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn-info{background:var(--primary);color:#fff}
    .btn-info:hover{opacity:.92}
    .btn-reg{background:var(--accent);color:#fff}
    .btn-reg:hover{filter:brightness(1.05)}
    /* Modals */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1000;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .modal-card{background:#fff;border-radius:16px;max-width:820px;width:100%;max-height:85vh;overflow:auto;box-shadow:var(--shadow-hover);position:relative;padding:20px}
    .modal-close{position:absolute;top:10px;right:12px;background:transparent;border:none;font-size:24px;cursor:pointer}
    .preline{white-space:pre-line}
    /* Registration / Test / Result */
    .panel{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:20px;margin:22px 0;display:none}
    .panel h3{margin:6px 0 14px}
    .panel input{width:100%;padding:12px 12px;border:1px solid #d9dbe3;border-radius:10px;margin:6px 0 10px}
    .panel .muted{color:var(--muted);font-size:13px}
    .panel .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .row .btn{margin-top:6px}
    .doc-banner{background:#f4f6ff;border:1px solid #dbe2ff;color:#334155;border-radius:10px;padding:10px 12px;margin:10px 0}
    .checkbox{display:flex;gap:10px;align-items:center;margin:8px 0;color:#111827}
    .checkbox input{width:auto}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-disabled{background:#cbd5e1;color:#6b7280;cursor:not-allowed}
    /* --- тест (выравнивание слева, компактные отступы) --- */
    .question{
      padding:12px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      margin:10px 0;
      text-align:left;            /* всё внутри строго слева */
    }
    .question p{
      margin:0 0 8px 0;           /* компактнее отступ под вопросом */
      font-weight:500;
      text-align:left;            /* на всякий */
    }
    /* контейнер с вариантами (на всякий случай) */
    #qBox{ text-align:left; }
    /* каждый вариант — сетка 2 колонки: [радио] [текст], чтобы переносы строк шли ровно */
    .radio{
      display:grid; 
      grid-template-columns: 18px 1fr;  /* ширина радиокнопки + текст */
      gap:8px;
      align-items:start;                 /* текст выравнивается по верхней линии радио */
      margin:4px 0;                      /* менее «воздушно» */
      text-align:left;                   /* на всякий */
    }
    .radio input{
      margin:2px 0 0 0;                 /* чуть опустить радио, чтобы совпадала линия с текстом */
    }
    .radio span{
      display:block;
      line-height:1.35;
      margin:0;
    }
    /* прочее в блоке результата тоже слева */
    .result-line{font-size:16px;margin:8px 0 4px;text-align:left;}
    .note{font-size:13px;color:var(--muted);text-align:left;}
    .divider{height:1px;background:#e5e7eb;margin:16px 0;}
    .center{text-align:center;}
    footer{background:var(--primary);color:#fff;padding:16px;text-align:center;font-size:14px;margin-top:40px}
    footer a{color:#fff;text-decoration:underline}
  </style>
</head>
<body>
<header>
  <h1>Международные и Всероссийские Олимпиады, Конкурсы и Проекты</h1>
</header>

<nav>
  <a href="/">Главная</a>
  <a href="/docs">Документы и оплата</a>
  <a href="/admin">Админка</a>
</nav>

<div class="container">
  <div class="intro">
    <div class="row">
      <span class="badge">Стоимость участия — бесплатное</span>
      <span class="badge">Наградные документы — 100 ₽</span>
    </div>
    <p>Для учащихся и молодых исследователей, обладающих значительным научным и интеллектуальным потенциалом, наши мероприятия представляют уникальную возможность реализации собственных способностей на самом высоком уровне.</p>
    <p><b>Почему стоит участвовать?</b></p>
    <ul>
      <li>✅ Подтверждение статуса высококвалифицированного специалиста международными сертификатами</li>
      <li>✅ Объективное сравнение своих знаний с лучшими представителями научного сообщества</li>
      <li>✅ Расширение возможностей карьерного роста и профессионального признания</li>
      <li>✅ Доступ к ведущим научным центрам и образовательным учреждениям</li>
    </ul>
  </div>

  <div class="filters">
    <button class="filter-btn active" data-filter="all">Все</button>
    <button class="filter-btn" data-filter="students">Студентам и аспирантам</button>
    <button class="filter-btn" data-filter="school">Школьникам и СПО</button>
    <button class="filter-btn" data-filter="teachers">Преподавателям и учителям</button>
  </div>

  <div class="search-wrap">
    <input id="search" type="text" placeholder="Поиск мероприятий по названию и описанию..." />
  </div>

  <div id="events" class="events-grid"></div>

  <!-- Регистрация -->
  <div id="regPanel" class="panel">
    <h3 id="regTitle">Регистрация на мероприятие</h3>
    <input id="fio" placeholder="Фамилия Имя Отчество" value="Иванов Иван Иванович" />
    <input id="region" placeholder="Регион" value="Краснодарский край" />
    <input id="city" placeholder="Город" value="Краснодар" />
    <input id="school" placeholder="Учебное заведение" value="ФГБОУ ВО Кубанский государственный аграрный университет имени И.Т. Трубилина" />
    <div class="doc-banner">
      Перед продолжением необходимо ознакомиться с документами:
      <div class="row">
        <button class="btn btn-primary" onclick="openDoc('terms')">Пользовательское соглашение и Правила</button>
        <button class="btn btn-primary" onclick="openDoc('privacy')">Политика конфиденциальности</button>
      </div>
    </div>
    <label class="checkbox"><input id="agreeTerms" type="checkbox" disabled /> Подтверждаю, что ознакомился(лась) с Пользовательским соглашением и Правилами</label>
    <label class="checkbox"><input id="agreePrivacy" type="checkbox" disabled /> Даю согласие на обработку персональных данных</label>
    <div class="row">
      <button id="payBtn" class="btn btn-primary btn-disabled" disabled onclick="startPayment()">Перейти к оплате</button>
      <span class="muted">Оплата Robokassa — заглушка</span>
    </div>
  </div>

  <!-- Тест -->
  <div id="testPanel" class="panel">
    <h3 id="testTitle">Тест</h3>
    <div id="qBox" class="question"></div>
    <div class="row">
      <button class="btn btn-primary" onclick="prevQ()">Назад</button>
      <button class="btn btn-primary" onclick="nextQ()">Далее</button>
      <button id="finishBtn" class="btn btn-primary" style="display:none" onclick="finishTest()">Завершить</button>
    </div>
  </div>

  <!-- Результат -->
  <div id="resultPanel" class="panel">
    <h3>Результаты</h3>
    <p class="result-line">Ваш результат: <b><span id="scoreText">0%</span></b></p>
    <div class="divider"></div>

    <!-- первая кнопка (без научного руководителя) -->
    <div class="row">
      <button id="downloadMain" class="btn btn-primary">Скачать документ</button>
      <span class="note">Диплом — при результате ≥ 51 %, сертификат — при результате 0–50 %.</span>
    </div>

    <div class="divider"></div>

    <!-- блок научного руководителя -->
    <label for="supervisor">Научный руководитель (необязательно):</label>
    <input id="supervisor" placeholder="ФИО научного руководителя" />
    <div class="row">
      <button id="downloadWithSup" class="btn btn-primary">Скачать документ с научным руководителем</button>
    </div>

    <p class="note">Печать организации добавится автоматически после загрузки файла печати (пока — заглушка).</p>
  </div>
</div>

<!-- Модалка: Подробнее -->
<div id="infoModal" class="modal">
  <div class="modal-card">
    <button class="modal-close" onclick="closeInfo()">×</button>
    <h3 id="infoTitle"></h3>
    <div id="infoText" class="preline"></div>
  </div>
</div>

<!-- Модалка: Документы -->
<div id="docModal" class="modal">
  <div class="modal-card">
    <button class="modal-close" onclick="closeDoc()">×</button>
    <h3 id="docTitle"></h3>
    <div id="docBody" class="preline" style="max-height:60vh;overflow:auto;border:1px solid #eef2ff;padding:12px;border-radius:10px;"></div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn btn-primary" id="docAcceptBtn" disabled onclick="acceptDoc()">Прочитал(а), согласен(на)</button>
    </div>
  </div>
</div>

<footer>
  Почта для связи: <a href="mailto:naych_kooper@mail.ru">naych_kooper@mail.ru</a><br>
  © 2025 Все права защищены. Копирование контента без разрешения автора строго ЗАПРЕЩЕНО!
</footer>

<script>
/* ====== ДАННЫЕ О МЕРОПРИЯТИЯХ (полные тексты «Подробнее») ====== */
const EVENTS = [
  {
    key:'stat',
    title:'Международная Олимпиада по статистике и прикладной математике',
    short:'Современные подходы к анализу данных и статистическим методам.',
    audience: 'students',
    info: `Приглашаем вас принять участие в Международной Олимпиаде по Статистике — «Статистика будущего: искусство анализа данных!»

Сегодня умение анализировать большие объемы информации становится ключевым фактором успеха как в повседневной жизни, так и в профессиональной деятельности. Умение выявлять закономерности, строить прогнозы и принимать обоснованные решения на основе статистических данных определяет вашу конкурентоспособность и перспективы развития. Наша олимпиада объединяет участников со всего мира, предлагая уникальную возможность обменяться опытом и знаниями с коллегами из разных стран.

Мы убеждены, что каждый участник существенно повысит свою компетентность и станет экспертом в области статистики!

✅ Вы освоите современные методы обработки и интерпретации данных.
✅ Узнаете эффективные подходы к решению практических задач с использованием статистического инструментария.
✅ Получите ценные навыки критического мышления и способности интерпретировать полученные результаты.

🏆 Наш формат — комфортный и инновационный:
⭐ Быстрая обратная связь: результаты станут вам известны моментально после окончания испытаний.
⭐ Призовые места обеспечены: каждому участнику выдается диплом или сертификат.`,
    questions: [
      {q:'По формуле (∑p1q1)/(∑p0q1) рассчитывают общий индекс цен', options:['Эджворта-Маршалла','Фишера','Ласпейреса','Пааше'], correct:3},
      {q:'Индекс, отражающий влияние уровня ставок по каждому кредиту на среднее изменение ставки — это индекс…', options:['Постоянного состава','Структурных сдвигов','Переменного состава','Индивидуальный'], correct:0},
      {q:'В общем индексе цен Пааше в качестве весов используется…', options:['товарооборот отчетного периода','индекс Фишера','товарооборот базисного периода','индекс Эджворта-Маршалла'], correct:0},
      {q:'Индекс, характеризующий изменение средней зарплаты за счет изменения зарплаты каждого работника — это индекс…', options:['Постоянного состава','Произвольного состава','Переменного состава','Структурных сдвигов'], correct:0},
      {q:'Выборка называется малой, если ее объем менее…', options:['30','40','50','100'], correct:0}
    ]
  },
  {
    key:'fin',
    title:'Международная Олимпиада по финансовым вычислениям в банковском секторе',
    short:'Финансовое мастерство и точность расчётов для будущих профессионалов.',
    audience: 'students',
    info: `Приглашаем вас принять участие в нашей уникальной олимпиаде по финансовому направлению — «Финансовое мастерство: точность вычислений!»

Сегодня финансовые знания становятся важнейшим инструментом успеха как в личной жизни, так и в профессиональной сфере. От умения грамотно рассчитать проценты, правильно распределять бюджет и планировать инвестиции зависит ваше благополучие и карьерный рост. Мы уверены, что каждый участник сможет значительно повысить свои компетенции и стать настоящим мастером финансового дела!

🔥 Почему стоит участвовать в нашей олимпиаде?

— Вы получите полезные знания и практические навыки в финансовой математике.
— Узнаете секреты эффективного планирования денежных потоков и принятия взвешенных инвестиционных решений.
— Получите ценный опыт, участвуя в реальных ситуациях и выполняя интересные задания.

🏅 Наш формат — удобный и современный:
✨ Результаты известны мгновенно: сразу же после завершения олимпиады вы узнаете точное количество набранных вами баллов.
✨ Награды доступны сразу: по окончании испытания каждый участник получает диплом или сертификат.`,
    questions: [
      {q:'Фактор времени учитывается с помощью', options:['процентной ставки','дисконта','ренты','конверсии'], correct:0},
      {q:'Процесс наращения — это…', options:['по исходной сумме найти ожидаемую','по будущей сумме найти исходный долг','норма дисконта','расчет доходности'], correct:0},
      {q:'Процесс дисконтирования — это…', options:['по исходной сумме найти ожидаемую','по будущей сумме найти исходный долг','расчет доходности','нет верного ответа'], correct:1},
      {q:'Чем выше конкуренция среди заемщиков…', options:['выше ставки по кредитам','ниже ставки по кредитам','хуже кредиторам','зависимость отсутствует'], correct:0},
      {q:'Капитализация процентов — это…', options:['относительная величина дохода','абсолютная величина дохода','присоединение процентов к сумме','все ответы верны'], correct:2}
    ]
  },
  {
    key:'prob',
    title:'Международная Олимпиада «Применение Теории вероятностей в экономике»',
    short:'Стохастика, риски и принятие решений в экономике.',
    audience: 'students',
    info: `Уважаемые студенты и молодые специалисты в сфере экономики!
Представляем вашему вниманию уникальную возможность проявить себя в мире сложных расчетов и увлекательных научных открытий. Впервые проводится Международная Олимпиада по дисциплине «Теория вероятностей в экономике».

Цель мероприятия — проверка ваших теоретических знаний и практических навыков решения задач, связанных с применением стохастики и статистики в финансовой среде. Вы сможете продемонстрировать своё умение анализировать рынки, оценивать риски и принимать обоснованные управленческие решения.

🏅 Наш формат — удобный и современный:
✨ Результаты известны мгновенно.
✨ Награды доступны сразу: по окончании испытания каждый участник получает диплом или сертификат.`,
    questions: [
      {q:'Что такое нормальное распределение?', options:['Нулевое значение риска','Единичное отклонение риска','Распределение Гаусса','Положительная прибыль'], correct:2},
      {q:'Плотность вероятности — это…', options:['Условная доходность','Полимодальная структура','Двумерная функция','Первая производная от функции распределения'], correct:3},
      {q:'Случайная экономическая величина — это…', options:['Критерий Фишера','Теорема Пуассона','Величина, полученная случайным процессом','Формула Бернулли'], correct:2},
      {q:'Дискретная случайная величина — это…', options:['Заданная плотностью','Равномерно распределённая на интервале','Принимающая значения из конечного набора'], correct:2},
      {q:'Коэффициент корреляции r = 0 означает…', options:['Нет линейной связи','Полная линейная зависимость','Один индикатор независим','Все индикаторы положительны'], correct:0}
    ]
  }
];

/* ====== ПОЛЬЗОВАТЕЛЬСКИЕ ДОКУМЕНТЫ ====== */
const LEGAL = {
  termsTitle: 'Пользовательское соглашение (публичная оферта) и Правила проведения олимпиады',
  termsText: `1. Пользовательское соглашение (публичная оферта)

1. Общие положения
1.1. Настоящее Пользовательское соглашение (далее – «Соглашение») регулирует отношения между Организатором онлайн-олимпиад и конкурсов (далее – «Организатор») и физическим лицом (далее – «Участник»), оставляющим свои данные через форму на сайте «olympiad-site.onrender.com».
1.2. Отправка данных через форму означает согласие Участника с условиями Соглашения.

2. Предмет соглашения
2.1. Организатор предоставляет Участнику возможность участия в онлайн-олимпиадах и конкурсах бесплатно.
2.2. Организатор предоставляет электронный диплом или сертификат за плату — 100 рублей за документ.

3. Права и обязанности сторон
Организатор обязуется: проводить олимпиаду; обработать результаты; предоставить диплом или сертификат после оплаты.
Участник обязуется: предоставлять достоверные данные при подаче заявки; оплачивать диплом или сертификат при его заказе.

4. Ответственность сторон
Организатор не несёт ответственности за ошибки в документах, возникшие по причине неверно указанных данных или отсутствия оплаты.

5. Заключительные положения
5.1. Соглашение является публичной офертой.
5.2. Организатор имеет право вносить изменения, публикуя их на сайте.

2. Правила проведения олимпиады

1. Участие
Для участия необходимо заполнить форму на сайте, указав ФИО, e-mail, учебное заведение и другие необходимые данные. Личный кабинет не требуется.

2. Порядок проведения
Олимпиада проводится онлайн в сроки, указанные на сайте. Задания направляются на e-mail или публикуются на сайте.

3. Итоги
Организатор обеспечивает возможность получить в электронном виде документ о результате олимпиады (диплом или сертификат после оплаты).

4. Документы
Электронный диплом или сертификат предоставляется только после оплаты — 100 рублей за документ.`,

  privacyTitle: 'Политика конфиденциальности и Согласие на обработку персональных данных',
  privacyText: (fio) => `3. Политика конфиденциальности

1. Какие данные мы собираем
ФИО, электронную почту, учебное заведение, класс/возраст и иные сведения, указанные в форме заявки.

2. Цели обработки
— оформление участия в олимпиаде;
— направление заданий и результатов;
— формирование и отправка дипломов/сертификатов после оплаты;
— информирование о новых мероприятиях.

3. Защита данных
Данные хранятся в защищённой базе; не передаются третьим лицам, кроме случаев доставки документов или по требованию закона.

4. Согласие на обработку персональных данных
«Я, ${fio || '______________________'}, заполняя форму участия на сайте «olympiad-site.onrender.com», выражаю согласие на обработку моих персональных данных (ФИО, e-mail, учебное заведение и другие сведения).
Цель обработки: участие в олимпиаде/конкурсе, подведение итогов, формирование и отправка дипломов/сертификатов после оплаты, а также информирование о результатах.
Согласие действует до его письменного отзыва.»`
};

/* ====== РЕНДЕР КАРТОЧЕК ====== */
const elEvents = document.getElementById('events');
const elSearch = document.getElementById('search');
let currentEvent = null;
let currentFilter = 'all';
let qIndex = 0;
let answers = [];
let pendingPDFType = null;

function renderEvents(list){
  elEvents.innerHTML = '';
  list.forEach((ev, idx) => {
    const card = document.createElement('div');
    card.className = 'event-card';
    card.innerHTML = `
      <div class="event-header">
        <h3 class="event-title">${ev.title}</h3>
      </div>
      <p class="event-desc">${ev.short}</p>
      <div class="card-actions">
        <button class="btn btn-info" onclick="openInfo('${ev.key}')">Подробнее</button>
        <button class="btn btn-reg" onclick="openReg('${ev.key}')">Регистрация</button>
      </div>
    `;
    elEvents.appendChild(card);
  });
}
renderEvents(EVENTS);

elSearch.addEventListener('input', e=>{
  const v = e.target.value.toLowerCase();
  const filtered = EVENTS.filter(ev =>
    ev.title.toLowerCase().includes(v) ||
    ev.short.toLowerCase().includes(v) ||
    ev.info.toLowerCase().includes(v)
  );
  renderEvents(filtered);
});

document.querySelectorAll('.filter-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    const filtered = currentFilter === 'all' ? EVENTS : EVENTS.filter(e=>e.audience===currentFilter);
    renderEvents(filtered);
  });
});

/* ====== Модалка «Подробнее» ====== */
function openInfo(key){
  currentEvent = EVENTS.find(e=>e.key===key);
  document.getElementById('infoTitle').textContent = currentEvent.title;
  document.getElementById('infoText').textContent = currentEvent.info; // pre-line сохраняет разрывы строк
  document.getElementById('infoModal').classList.add('open');
}
function closeInfo(){ document.getElementById('infoModal').classList.remove('open'); }

/* ====== Регистрация ====== */
function openReg(key){
  currentEvent = EVENTS.find(e=>e.key===key);
  document.getElementById('regTitle').textContent = 'Регистрация: ' + currentEvent.title;
  document.getElementById('regPanel').style.display = 'block';
  document.getElementById('testPanel').style.display='none';
  document.getElementById('resultPanel').style.display='none';
  window.scrollTo({top: document.getElementById('regPanel').offsetTop-6, behavior:'smooth'});
  // сброс галочек
  document.getElementById('agreeTerms').checked = false; document.getElementById('agreeTerms').disabled = true;
  document.getElementById('agreePrivacy').checked = false; document.getElementById('agreePrivacy').disabled = true;
  document.getElementById('payBtn').disabled = true; document.getElementById('payBtn').classList.add('btn-disabled');
  // обнулим маркер акцепта документов
  window.docStage = {terms: false, privacy: false};
}

/* ====== Документы (обязательное открытие) ====== */
function openDoc(type){
  window.docTypeOpen = type;
  document.getElementById('docAcceptBtn').disabled = true; // будет активна после прокрутки в конец
  const fio = document.getElementById('fio').value.trim();
  if(type==='terms'){
    document.getElementById('docTitle').textContent = LEGAL.termsTitle;
    document.getElementById('docBody').textContent = LEGAL.termsText;
  } else {
    document.getElementById('docTitle').textContent = LEGAL.privacyTitle;
    document.getElementById('docBody').textContent = LEGAL.privacyText(fio);
  }
  document.getElementById('docModal').classList.add('open');
  document.getElementById('docBody').scrollTop = 0;
}
function closeDoc(){ document.getElementById('docModal').classList.remove('open'); }
document.getElementById('docBody').addEventListener('scroll', ()=> {
  // Разрешаем принять, когда пользователь долистал до низа
  const atBottom = Math.ceil(document.getElementById('docBody').scrollTop + document.getElementById('docBody').clientHeight) >= document.getElementById('docBody').scrollHeight;
  document.getElementById('docAcceptBtn').disabled = !atBottom;
});
function acceptDoc(){
  if(window.docTypeOpen==='terms'){
    document.getElementById('agreeTerms').disabled = false;
    document.getElementById('agreeTerms').checked = true;
    window.docStage.terms = true;
  } else {
    document.getElementById('agreePrivacy').disabled = false;
    document.getElementById('agreePrivacy').checked = true;
    window.docStage.privacy = true;
  }
  closeDoc();
  // К оплате — только если оба документа приняты
  if(window.docStage.terms && window.docStage.privacy){
    document.getElementById('payBtn').disabled = false;
    document.getElementById('payBtn').classList.remove('btn-disabled');
  }
}

/* ====== Оплата (заглушка) → запуск теста ====== */
function startPayment(){
  alert('Оплата через Robokassa (заглушка).\nПосле интеграции будет переход на платёжную страницу и callback.');
  startTest();
}

/* ====== Тест: по одному вопросу ====== */
const testPanel = document.getElementById('testPanel');
const testTitle = document.getElementById('testTitle');
const qBox = document.getElementById('qBox');
const finishBtn = document.getElementById('finishBtn');

function startTest(){
  testTitle.textContent = 'Тест: ' + currentEvent.title;
  regPanel.style.display='none';
  testPanel.style.display='block';
  answers = new Array(currentEvent.questions.length).fill(null);
  qIndex = 0;
  renderQuestion();
  window.scrollTo({top:testPanel.offsetTop-6, behavior:'smooth'});
}

function renderQuestion(){
  const q = currentEvent.questions[qIndex];
  qBox.innerHTML = `
    <p><b>${qIndex+1} / ${currentEvent.questions.length}</b>. ${q.q}</p>
    ${q.options.map((opt,i)=>`
      <label class="radio">
        <input type="radio" name="opt" value="${i}" ${answers[qIndex]===i?'checked':''}/>
        <span>${opt}</span>
      </label>
    `).join('')}
  `;
  finishBtn.style.display = (qIndex === currentEvent.questions.length-1) ? 'inline-block' : 'none';
}

function nextQ(){
  const sel = document.querySelector('input[name="opt"]:checked');
  if(!sel){ alert('Пожалуйста, выберите вариант ответа.'); return; }
  answers[qIndex] = parseInt(sel.value,10);
  if(qIndex < currentEvent.questions.length-1){
    qIndex++; renderQuestion();
  }
}
function prevQ(){
  if(qIndex>0){ qIndex--; renderQuestion(); }
}

function finishTest(){
  const sel = document.querySelector('input[name="opt"]:checked');
  if(sel) answers[qIndex] = parseInt(sel.value,10);
  let correct = 0;
  currentEvent.questions.forEach((q,i)=>{ if(answers[i]===q.correct) correct++; });
  const score = Math.round(correct / currentEvent.questions.length * 100);
  showResult(score);
}

/* ====== Результаты и PDF ====== */
const resultPanel = document.getElementById('resultPanel');
const scoreText = document.getElementById('scoreText');

function showResult(score){
  testPanel.style.display='none';
  resultPanel.style.display='block';
  scoreText.textContent = score + '%';
  window._resultScore = score;

  // подпись на первой кнопке в зависимости от результата
  const btnMain = document.getElementById('downloadMain');
  btnMain.textContent = (score >= 51) ? 'Скачать диплом победителя' : 'Скачать сертификат участника';
}

document.getElementById('downloadMain').onclick = () => {
  downloadPDF(false);
};
document.getElementById('downloadWithSup').onclick = () => {
  downloadPDF(true);
};

async function downloadPDF(withSupervisor){
  const fio = document.getElementById('fio').value.trim() || 'Участник';
  const region = document.getElementById('region').value.trim();
  const city = document.getElementById('city').value.trim();
  const school = document.getElementById('school').value.trim();
  const supervisor = withSupervisor ? (document.getElementById('supervisor').value.trim()) : '';
  const score = window._resultScore||0;
  const docType = (score >= 51) ? 'ДИПЛОМ I СТЕПЕНИ' : 'СЕРТИФИКАТ УЧАСТНИКА';
  const number = '2025-' + String(Math.floor(Math.random()*100000)).padStart(5,'0');
  const today = new Date().toLocaleDateString('ru-RU');

  // Перенос "универси-тет"
  const schoolWithBreak = school.replace(/(универси)(тет)/gi, '$1-<br>$2');

  let contentHtml = '';
  if (docType === 'ДИПЛОМ I СТЕПЕНИ') {
    contentHtml = `
      <div style="text-align:center; margin-bottom:20px; font-size:18px; font-weight:bold;">${currentEvent.title}</div>
      <div style="font-size:24px; font-weight:bold; text-align:center; margin:20px 0;">ДИПЛОМ I СТЕПЕНИ</div>
      <div style="text-align:center; margin:10px 0;">награждён(а):</div>
      <div style="font-size:20px; font-weight:bold; text-align:center; margin:10px 0;">${fio}</div>
      <div style="text-align:center;">${schoolWithBreak}, ${region}, ${city}</div>
      ${supervisor ? `<div style="margin-top:20px; text-align:center;">Научный руководитель(преподаватель):<br>${supervisor}</div>` : ''}
      <div style="margin-top:40px; text-align:center; font-size:14px;">Дата: ${today}<br>№ документа ${number}</div>
    `;
  } else {
    contentHtml = `
      <div style="text-align:center; margin-bottom:20px; font-size:18px; font-weight:bold;">${currentEvent.title}</div>
      <div style="font-size:24px; font-weight:bold; text-align:center; margin:20px 0;">СЕРТИФИКАТ УЧАСТНИКА</div>
      <div style="font-size:20px; font-weight:bold; text-align:center; margin:20px 0;">${fio}</div>
      <div style="text-align:center;">${schoolWithBreak}, ${region}, ${city}</div>
      ${supervisor ? `<div style="margin-top:20px; text-align:center;">Научный руководитель(преподаватель):<br>${supervisor}</div>` : ''}
      <div style="margin-top:40px; text-align:center; font-size:14px;">Дата: ${today}<br>№ документа ${number}</div>
    `;
  }

  const fullHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        @page { size: A4 landscape; margin: 0; }
        body { margin: 0; padding: 0; font-family: "Times New Roman", serif; background: white; }
        .container { position: relative; width: 297mm; height: 210mm; }
        .background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.1; object-fit: cover; }
        .content { position: relative; z-index: 1; padding: 40px 60px; color: black; line-height: 1.4; font-size: 16px; height: 100%; box-sizing: border-box; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="content">${contentHtml}</div>
      </div>
    </body>
    </html>
  `;

  try {
    const opt = {
      margin: 0,
      filename: `${docType === 'ДИПЛОМ I СТЕПЕНИ' ? 'diploma' : 'certificate'}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    };

    html2pdf().set(opt).from(fullHtml).save().finally(() => {
      // Сохраняем участника в "базу данных"
      const participantRecord = {
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        template: docType === 'ДИПЛОМ I СТЕПЕНИ' ? 'diploma' : 'certificate',
         { 
          fio: fio,
          school: school,
          region: region,
          city: city,
          supervisor: supervisor,
          date: today,
          number: number
        }
      };
      console.log('Участник сохранён:', participantRecord);
    });

  } catch (e) {
    console.error('PDF Error:', e);
    alert('Ошибка генерации PDF: ' + e.message);
  }
}
</script>
</body>
</html>
