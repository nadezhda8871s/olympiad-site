<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Админка</title>
  <style>
    :root{--primary:#1b365d;--accent:#2ecc71;--bg:#f5f7fb;--text:#2b2b2b;--muted:#6b7280;--card:#ffffff;--shadow:0 6px 18px rgba(0,0,0,.08);--shadow-hover:0 10px 24px rgba(0,0,0,.12);--radius:14px}
    *{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    header{background:var(--primary);color:#fff;padding:28px 16px;text-align:center}
    nav{background:#fff;padding:12px 0;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    nav a{margin:0 12px;text-decoration:none;color:var(--primary);font-weight:600}
    nav a:hover{text-decoration:underline}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .intro{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-top:-24px}
    .badge{display:inline-block;background:#eef2ff;color:#3442b5;border:1px solid #dbe2ff;border-radius:999px;padding:6px 12px;font-size:13px;margin-right:8px}
    .filters{display:flex;justify-content:center;gap:10px;margin:16px 0;flex-wrap:wrap}
    .filter-btn{padding:8px 16px;border:1px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer;font-size:14px}
    .filter-btn.active{background:var(--primary);color:#fff}
    .search-wrap{display:flex;gap:10px;justify-content:center;margin:16px 0}
    .search-wrap input{width:100%;max-width:420px;padding:12px 14px;border:1px solid #d9dbe3;border-radius:10px;background:#fff}
    .events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
    .event-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;transition:.2s ease;overflow:hidden}
    .event-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover)}
    .event-header{padding:18px 18px 10px}
    .event-title{margin:0;color:var(--primary);font-size:18px;line-height:1.3}
    .event-desc{color:var(--muted);font-size:14px;padding:0 18px 10px}
    .card-actions{display:flex;gap:10px;padding:14px 18px 18px;margin-top:auto}
    .btn{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn-info{background:var(--primary);color:#fff}
    .btn-info:hover{opacity:.92}
    .btn-reg{background:var(--accent);color:#fff}
    .btn-reg:hover{filter:brightness(1.05)}
    /* Modals */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1000;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .modal-card{background:#fff;border-radius:16px;max-width:820px;width:100%;max-height:85vh;overflow:auto;box-shadow:var(--shadow-hover);position:relative;padding:20px}
    .modal-card h3{margin:4px 0 8px}
    .modal-close{position:absolute;top:10px;right:12px;background:transparent;border:none;font-size:24px;cursor:pointer}
    .preline{white-space:pre-line}
    /* Registration / Test / Result */
    .panel{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:20px;margin:22px 0;display:none}
    .panel h3{margin:6px 0 14px}
    .panel input{width:100%;padding:12px 12px;border:1px solid #d9dbe3;border-radius:10px;margin:6px 0 10px}
    .panel .muted{color:var(--muted);font-size:13px}
    .panel .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .row .btn{margin-top:6px}
    .doc-banner{background:#f4f6ff;border:1px solid #dbe2ff;color:#334155;border-radius:10px;padding:10px 12px;margin:10px 0}
    .checkbox{display:flex;gap:10px;align-items:center;margin:8px 0;color:#111827}
    .checkbox input{width:auto}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-disabled{background:#cbd5e1;color:#6b7280;cursor:not-allowed}
    /* --- тест (выравнивание слева, компактные отступы) --- */
    .question{
      padding:12px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      margin:10px 0;
      text-align:left;            /* всё внутри строго слева */
    }
    .question p{
      margin:0 0 8px 0;           /* компактнее отступ под вопросом */
      font-weight:500;
      text-align:left;            /* на всякий */
    }
    /* контейнер с вариантами (на всякий случай) */
    #qBox{ text-align:left; }
    /* каждый вариант — сетка 2 колонки: [радио] [текст], чтобы переносы строк шли ровно */
    .radio{
      display:grid; 
      grid-template-columns: 18px 1fr;  /* ширина радиокнопки + текст */
      gap:8px;
      align-items:start;                 /* текст выравнивается по верхней линии радио */
      margin:4px 0;                      /* менее «воздушно» */
      text-align:left;                   /* на всякий */
    }
    .radio input{
      margin:2px 0 0 0;                 /* чуть опустить радио, чтобы совпадала линия с текстом */
    }
    .radio span{
      display:block;
      line-height:1.35;
      margin:0;
    }
    /* прочее в блоке результата тоже слева */
    .result-line{font-size:16px;margin:8px 0 4px;text-align:left;}
    .note{font-size:13px;color:var(--muted);text-align:left;}
    .divider{height:1px;background:#e5e7eb;margin:16px 0;}
    .center{text-align:center;}
    footer{background:var(--primary);color:#fff;padding:16px;text-align:center;font-size:14px;margin-top:40px}
    footer a{color:#fff;text-decoration:underline}
    .admin-login { max-width: 400px; margin: 50px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: var(--shadow); }
    .admin-login h2 { margin-bottom: 20px; text-align: center; }
    .admin-login input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
    .admin-login button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; }
    .admin-login .error { color: red; margin-top: 10px; text-align: center; }
    .upload-section { background: #f0f7ff; padding: 20px; border-radius: 10px; margin: 20px 0; }
    .upload-section h3 { margin-top: 0; }
    .events-manager { margin: 20px 0; }
    .event-editor { background: #f9fafb; padding: 15px; border-radius: 10px; margin: 10px 0; }
    .event-editor input, .event-editor textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
    .event-editor .question-editor { background: #fff; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .event-editor .question-editor input, .event-editor .question-editor textarea { width: calc(100% - 20px); }
    .btn-remove { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    .btn-add { background: var(--accent); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin: 5px 0; }
  </style>
</head>
<body>
<div class="admin-login" id="loginForm">
  <h2>Вход в админку</h2>
  <input id="login" placeholder="Логин" value="nadezhda8871s">
  <input id="password" type="password" placeholder="Пароль" value="1988NAna">
  <button onclick="login()">Войти</button>
  <div class="error" id="loginError"></div>
</div>

<div class="container" id="adminPanel" style="display:none;">
  <header>
    <h1>Админка</h1>
  </header>

  <nav>
    <a href="#" onclick="showTab('settings')">Настройки</a>
    <a href="#" onclick="showTab('events')">Мероприятия</a>
    <a href="#" onclick="showTab('backgrounds')">Фоны</a>
    <a href="#" onclick="showTab('export')">Экспорт</a>
    <a href="/" target="_blank">← На сайт</a>
  </nav>

  <!-- Настройки -->
  <div id="settingsTab" class="panel" style="display:block;">
    <h3>Редактирование текста «Документы и оплата»</h3>
    <textarea id="paymentText" rows="10"></textarea>
    <button class="btn btn-primary" onclick="saveSettings()">Сохранить</button>
  </div>

  <!-- Мероприятия -->
  <div id="eventsTab" class="panel">
    <h3>Управление мероприятиями</h3>
    <div id="eventsManager" class="events-manager"></div>
    <button class="btn btn-add" onclick="addEvent()">Добавить мероприятие</button>
  </div>

  <!-- Фоны -->
  <div id="backgroundsTab" class="panel">
    <h3>Загрузка фонов</h3>
    <div class="upload-section">
      <h4>Общий фон (PNG)</h4>
      <input type="file" id="bgAll" accept=".png">
      <button class="btn btn-primary" onclick="uploadBackground('all')">Загрузить</button>
    </div>
    <div class="upload-section">
      <h4>Фон для дипломов (PNG)</h4>
      <input type="file" id="bgDiploma" accept=".png">
      <button class="btn btn-primary" onclick="uploadBackground('diploma')">Загрузить</button>
    </div>
    <div class="upload-section">
      <h4>Фон для сертификатов (PNG)</h4>
      <input type="file" id="bgCertificate" accept=".png">
      <button class="btn btn-primary" onclick="uploadBackground('certificate')">Загрузить</button>
    </div>
    <div class="upload-section">
      <h4>Фон для благодарностей (PNG)</h4>
      <input type="file" id="bgThanks" accept=".png">
      <button class="btn btn-primary" onclick="uploadBackground('thanks')">Загрузить</button>
    </div>
  </div>

  <!-- Экспорт -->
  <div id="exportTab" class="panel">
    <h3>Экспорт данных участников</h3>
    <button class="btn btn-primary" onclick="exportParticipants()">Скачать данные (XLSX)</button>
  </div>
</div>

<script>
let authToken = null;
let eventsData = [];

// Вход в админку
async function login() {
  const login = document.getElementById('login').value;
  const password = document.getElementById('password').value;
  const credentials = btoa(`${login}:${password}`);

  try {
    const res = await fetch('/api/settings', {
      headers: { 'Authorization': `Basic ${credentials}` }
    });
    if (res.ok) {
      authToken = credentials;
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      loadSettings();
      loadEvents();
    } else {
      document.getElementById('loginError').textContent = 'Неверный логин или пароль';
    }
  } catch (e) {
    document.getElementById('loginError').textContent = 'Ошибка соединения';
  }
}

// Загрузка настроек
async function loadSettings() {
  const res = await fetch('/api/settings');
  const settings = await res.json();
  document.getElementById('paymentText').value = settings.paymentText;
}

// Сохранение настроек
async function saveSettings() {
  const paymentText = document.getElementById('paymentText').value;
  await fetch('/api/settings', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Basic ${authToken}`
    },
    body: JSON.stringify({ paymentText })
  });
  alert('Настройки сохранены');
}

// Загрузка мероприятий
async function loadEvents() {
  const res = await fetch('/api/events');
  eventsData = await res.json();
  renderEventsManager();
}

// Отображение редактора мероприятий
function renderEventsManager() {
  const container = document.getElementById('eventsManager');
  container.innerHTML = '';
  eventsData.forEach((event, index) => {
    const div = document.createElement('div');
    div.className = 'event-editor';
    div.innerHTML = `
      <h4>Мероприятие ${index + 1}</h4>
      <input placeholder="Ключ (key)" value="${event.key}">
      <input placeholder="Название (title)" value="${event.title}">
      <input placeholder="Краткое описание (short)" value="${event.short}">
      <input placeholder="Аудитория (audience)" value="${event.audience}">
      <textarea placeholder="Полный текст (info)" rows="5">${event.info}</textarea>
      <h5>Вопросы</h5>
      <div class="questions-list">
        ${(event.questions || []).map((q, qIndex) => `
          <div class="question-editor">
            <input placeholder="Вопрос" value="${q.q}">
            <textarea placeholder="Варианты (по одному на строку)" rows="3">${q.options.join('\\n')}</textarea>
            <input placeholder="Номер правильного ответа (0-3)" type="number" min="0" max="3" value="${q.correct}">
            <button class="btn-remove" onclick="removeQuestion(${index}, ${qIndex})">Удалить вопрос</button>
          </div>
        `).join('')}
      </div>
      <button class="btn-add" onclick="addQuestion(${index})">Добавить вопрос</button>
      <button class="btn-remove" onclick="removeEvent(${index})">Удалить мероприятие</button>
    `;
    container.appendChild(div);
  });
}

// Добавление мероприятия
function addEvent() {
  eventsData.push({
    key: 'new-event-' + Date.now(),
    title: 'Новое мероприятие',
    short: 'Краткое описание',
    audience: 'students',
    info: 'Полный текст...',
    questions: []
  });
  renderEventsManager();
}

// Удаление мероприятия
function removeEvent(index) {
  eventsData.splice(index, 1);
  renderEventsManager();
}

// Добавление вопроса
function addQuestion(eventIndex) {
  if (!eventsData[eventIndex].questions) eventsData[eventIndex].questions = [];
  eventsData[eventIndex].questions.push({
    q: 'Новый вопрос',
    options: ['Вариант 1', 'Вариант 2', 'Вариант 3', 'Вариант 4'],
    correct: 0
  });
  renderEventsManager();
}

// Удаление вопроса
function removeQuestion(eventIndex, qIndex) {
  eventsData[eventIndex].questions.splice(qIndex, 1);
  renderEventsManager();
}

// Сохранение мероприятий
async function saveEvents() {
  const editors = document.querySelectorAll('.event-editor');
  const updatedEvents = [];
  
  editors.forEach((editor, index) => {
    const inputs = editor.querySelectorAll('input');
    const textareas = editor.querySelectorAll('textarea');
    const key = inputs[0].value;
    const title = inputs[1].value;
    const short = inputs[2].value;
    const audience = inputs[3].value;
    const info = textareas[0].value;
    
    const questions = [];
    const qEditors = editor.querySelectorAll('.question-editor');
    qEditors.forEach(qEditor => {
      const qInputs = qEditor.querySelectorAll('input');
      const qTextareas = qEditor.querySelectorAll('textarea');
      const q = qInputs[0].value;
      const options = qTextareas[0].value.split('\\n').filter(o => o.trim());
      const correct = parseInt(qInputs[1].value) || 0;
      questions.push({ q, options, correct });
    });
    
    updatedEvents.push({ key, title, short, audience, info, questions });
  });
  
  await fetch('/api/events', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Basic ${authToken}`
    },
    body: JSON.stringify(updatedEvents)
  });
  alert('Мероприятия сохранены');
}

// Загрузка фона
async function uploadBackground(type) {
  const fileInput = document.getElementById('bg' + type.charAt(0).toUpperCase() + type.slice(1));
  const file = fileInput.files[0];
  if (!file) return alert('Выберите файл PNG');
  
  const formData = new FormData();
  formData.append('background', file);
  formData.append('docType', type);
  
  const res = await fetch('/api/upload-background', {
    method: 'POST',
    headers: { 'Authorization': `Basic ${authToken}` },
    body: formData
  });
  
  if (res.ok) {
    alert(`Фон для ${type} загружен`);
  } else {
    const err = await res.json();
    alert('Ошибка: ' + err.error);
  }
}

// Экспорт участников
async function exportParticipants() {
  window.location.href = '/api/export-participants';
}

// Переключение вкладок
function showTab(tab) {
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById(tab + 'Tab').style.display = 'block';
  
  if (tab === 'events') {
    loadEvents();
  }
}
</script>
</body>
</html>
