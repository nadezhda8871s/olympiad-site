// public/js/about.js
document.addEventListener('DOMContentLoaded', () => {
    const aboutSection = document.querySelector('.about-section');
    const editableTextArea = document.getElementById('editable-about-text');
    const saveButton = document.getElementById('save-about-btn');
    const innSpan = document.getElementById('about-inn');
    const phoneSpan = document.getElementById('about-phone');
    const addressSpan = document.getElementById('about-address');
    const emailLink = document.getElementById('about-email');
    const requisitesPre = document.getElementById('about-requisites');

    console.log("About page loaded...");

    // Загружаем данные "О нас"
    loadAboutData();

    async function loadAboutData() {
        try {
            const response = await fetch('/api/admin/about');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const aboutData = await response.json();

            // Заполняем статические поля
            innSpan.textContent = aboutData.inn || '231120569701';
            phoneSpan.textContent = aboutData.phone || '89184455287';
            addressSpan.textContent = aboutData.address || 'г. Краснодар, ул. Виноградная, 58';
            emailLink.href = `mailto:${aboutData.email || 'vsemnayka@gmail.com'}`;
            emailLink.textContent = aboutData.email || 'vsemnayka@gmail.com';
            requisitesPre.textContent = aboutData.requisites || 'ООО "РУБИКОН-ПРИНТ"\nИНН: 2311372333\nР/с: 40702810620000167717\nБанк: ООО "Банк Точка"\nБИК: 044525104\nК/с: 30101810745374525104';

            // Заполняем редактируемое поле
            // Предположим, что в `aboutData` есть поле `customText`
            editableTextArea.value = aboutData.customText || 'Добро пожаловать! Участвуйте в олимпиадах, конкурсах научных работ, ВКР и конференциях!\nДокументы формируются в течение 5 дней. Удобная оплата. Высокий уровень мероприятий.';
            
            // --- НОВОЕ: Добавляем обработчик для редактирования ---
            // Пока что просто делаем поле доступным для редактирования
            // В реальном приложении здесь должна быть логика аутентификации
            editableTextArea.readOnly = false; // Разрешаем редактирование
            
            // Показываем кнопку сохранения
            saveButton.style.display = 'block';
            
            // Добавляем обработчик события для кнопки сохранения
            saveButton.addEventListener('click', saveAboutText);
            // --- КОНЕЦ НОВОГО ---
            
        } catch (error) {
            console.error("Error loading 'about' ", error);
            // Можно показать сообщение об ошибке пользователю
        }
    }

    // --- НОВАЯ ФУНКЦИЯ: Сохранение текста "О нас" ---
    async function saveAboutText() {
        const newCustomText = editableTextArea.value.trim();
        
        try {
            const response = await fetch('/api/admin/about/custom-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ customText: newCustomText })
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    alert('Текст "О нас" успешно обновлён!');
                    // Перезагружаем данные, чтобы убедиться, что они сохранились
                    loadAboutData();
                } else {
                    alert('Ошибка при обновлении текста "О нас".');
                }
            } else {
                const errorData = await response.json();
                alert(errorData.error || 'Ошибка при обновлении текста "О нас".');
            }
        } catch (error) {
            console.error("Save about text error:", error);
            alert('Ошибка сети при обновлении текста "О нас".');
        }
    }
    // --- КОНЕЦ НОВОЙ ФУНКЦИИ ---
});
